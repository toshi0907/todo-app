<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>TODOã‚¢ãƒ—ãƒª</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/main.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>TODOãƒªã‚¹ãƒˆ</h1>
    <div style="text-align:right; color:#64748b; font-size:0.98em; margin-bottom:0.5em;">
      ç¾åœ¨æ™‚åˆ»: <%= now.toLocaleString('ja-JP', { hour12: false }) %>
    </div>    
    <details class="settings-details" style="margin-bottom:1em;">
      <summary class="settings-summary" style="cursor:pointer; font-weight:bold; color:#2563eb; padding:0.3em 0;">
      å„ç¨®è¨­å®š
      </summary>
      <div class="settings-content" style="margin-top:0.5em;">
      <a href="/categories" class="btn btn-outline-primary" title="ã‚«ãƒ†ã‚´ãƒªç®¡ç†" style="font-size:1.1em;">
        ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªç®¡ç†
      </a>
      </div>
    </details>
    <form action="/add" method="post">
      <input type="text" name="task" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯" required>
      <select name="due_type" id="due_type" style="margin-bottom:0.2em;">
        <option value="date">æ—¥ä»˜ã®ã¿</option>
        <option value="datetime">æ—¥ä»˜ï¼‹æ™‚é–“</option>
      </select>
      <input type="date" name="due_date" id="due_date" placeholder="æœŸé™æ—¥" style="display:inline-block;">
      <input type="datetime-local" name="due_datetime" id="due_datetime" placeholder="æœŸé™æ—¥æ™‚" style="display:none;">
      <script>
        // å…¥åŠ›åˆ‡æ›¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
        document.addEventListener('DOMContentLoaded', function() {
          const typeSel = document.getElementById('due_type');
          const dateInput = document.getElementById('due_date');
          const datetimeInput = document.getElementById('due_datetime');
          typeSel.addEventListener('change', function() {
            if (typeSel.value === 'datetime') {
              dateInput.style.display = 'none';
              datetimeInput.style.display = 'inline-block';
            } else {
              dateInput.style.display = 'inline-block';
              datetimeInput.style.display = 'none';
            }
          });
        });
      </script>
      <select name="category_id">
        <option value="">ã‚«ãƒ†ã‚´ãƒªé¸æŠ</option>
        <% categories.forEach(cat => { %>
          <option value="<%= cat.id %>"><%= cat.name %></option>
        <% }) %>
      </select>
      <button type="submit" title="è¿½åŠ ">â•</button>      
    </form>
    <% const today = new Date().toISOString().slice(0, 10); %>
    <!-- ã‚«ãƒ†ã‚´ãƒªæœªè¨­å®šã‚’å…ˆé ­ã«è¡¨ç¤º -->
    <div class="category-block">
      <div class="category-title">ã‚«ãƒ†ã‚´ãƒªæœªè¨­å®š</div>
      <ul>
        <% todos.filter(todo => !todo.category_id).forEach(todo => { %>
          <%- include('partials/task', { todo, today }) %>
        <% }) %>
      </ul>
    </div>
    <!-- ã‚«ãƒ†ã‚´ãƒªä»˜ãã‚¿ã‚¹ã‚¯ã‚’å¾Œã‚ã« -->
    <% categories.forEach(cat => { %>
      <div class="category-block">
        <div class="category-title"><%= cat.name %></div>
        <ul>
          <% todos.filter(todo => todo.category_id === cat.id).forEach(todo => { %>
            <%- include('partials/task', { todo, today }) %>
          <% }) %>
        </ul>
      </div>
    <% }) %>
    <%- include('footer') %>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    document.querySelectorAll('form[action^="/delete/"] button[type="submit"]').forEach(btn => {
      btn.addEventListener('click', function(e) {
        if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
          e.preventDefault();
        }
      });
    });

    // Ajaxæ©Ÿèƒ½ã®åˆæœŸåŒ–
    initAjaxFunctionality();
  });

  function initAjaxFunctionality() {
    // ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®AjaxåŒ–
    const addForm = document.querySelector('form[action="/add"]');
    if (addForm) {
      addForm.addEventListener('submit', handleTaskAdd);
    }

    // å„ã‚¿ã‚¹ã‚¯ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå®Œäº†ãƒ»å‰Šé™¤ç­‰ï¼‰ã®AjaxåŒ–
    attachTaskActionListeners();
  }

  function handleTaskAdd(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // é€ä¿¡ä¸­ã®è¡¨ç¤º
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = 'â³';
    submitBtn.disabled = true;

    fetch('/api/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        task: formData.get('task'),
        due_date: formData.get('due_date'),
        due_datetime: formData.get('due_datetime'),
        category_id: formData.get('category_id')
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        form.reset();
        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°
        refreshTaskList();
      } else {
        throw new Error(data.error || 'ã‚¿ã‚¹ã‚¯è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(error => {
      console.error('Ajax error:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å¾“æ¥ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      submitBtn.innerHTML = originalBtnText;
      submitBtn.disabled = false;
      form.removeEventListener('submit', handleTaskAdd);
      form.submit();
    })
    .finally(() => {
      submitBtn.innerHTML = originalBtnText;
      submitBtn.disabled = false;
    });
  }

  function attachTaskActionListeners() {
    // å®Œäº†/æœªå®Œäº†ãƒœã‚¿ãƒ³
    document.querySelectorAll('form[action^="/done/"], form[action^="/undone/"]').forEach(form => {
      form.addEventListener('submit', handleTaskAction);
    });

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    document.querySelectorAll('form[action^="/delete/"]').forEach(form => {
      form.addEventListener('submit', handleTaskDelete);
    });
  }

  function handleTaskAction(e) {
    e.preventDefault();
    const form = e.target;
    const action = form.getAttribute('action');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›
    const apiAction = action.replace('/done/', '/api/done/').replace('/undone/', '/api/undone/');
    
    // é€ä¿¡ä¸­ã®è¡¨ç¤º
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = 'â³';
    submitBtn.disabled = true;

    fetch(apiAction, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°
        refreshTaskList();
      } else {
        throw new Error(data.error || 'ã‚¿ã‚¹ã‚¯æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(error => {
      console.error('Ajax error:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å¾“æ¥ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      submitBtn.innerHTML = originalBtnText;
      submitBtn.disabled = false;
      form.removeEventListener('submit', handleTaskAction);
      form.submit();
    })
    .finally(() => {
      submitBtn.innerHTML = originalBtnText;
      submitBtn.disabled = false;
    });
  }

  function handleTaskDelete(e) {
    e.preventDefault();
    const form = e.target;
    const action = form.getAttribute('action');
    
    // å‰Šé™¤ç¢ºèª
    if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
      return;
    }

    const submitBtn = form.querySelector('button[type="submit"]');
    const apiAction = action.replace('/delete/', '/api/delete/');
    
    // é€ä¿¡ä¸­ã®è¡¨ç¤º
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = 'â³';
    submitBtn.disabled = true;

    fetch(apiAction, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°
        refreshTaskList();
      } else {
        throw new Error(data.error || 'ã‚¿ã‚¹ã‚¯å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(error => {
      console.error('Ajax error:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å¾“æ¥ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      submitBtn.innerHTML = originalBtnText;
      submitBtn.disabled = false;
      form.removeEventListener('submit', handleTaskDelete);
      form.submit();
    })
    .finally(() => {
      submitBtn.innerHTML = originalBtnText;
      submitBtn.disabled = false;
    });
  }

  function refreshTaskList() {
    fetch('/api/todos')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      updateTaskListDOM(data.todos, data.categories);
    })
    .catch(error => {
      console.error('Failed to refresh task list:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
      window.location.reload();
    });
  }

  function updateTaskListDOM(todos, categories) {
    const today = new Date().toISOString().slice(0, 10);
    
    // ã‚«ãƒ†ã‚´ãƒªæœªè¨­å®šã®ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
    const uncategorizedBlock = document.querySelector('.category-block:first-of-type ul');
    if (uncategorizedBlock) {
      const uncategorizedTodos = todos.filter(todo => !todo.category_id);
      uncategorizedBlock.innerHTML = uncategorizedTodos.map(todo => generateTaskHTML(todo, today)).join('');
    }

    // ã‚«ãƒ†ã‚´ãƒªä»˜ãã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
    categories.forEach((cat, index) => {
      const categoryBlock = document.querySelectorAll('.category-block')[index + 1];
      if (categoryBlock) {
        const categoryTodos = todos.filter(todo => todo.category_id === cat.id);
        const ul = categoryBlock.querySelector('ul');
        if (ul) {
          ul.innerHTML = categoryTodos.map(todo => generateTaskHTML(todo, today)).join('');
        }
      }
    });

    // æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    attachTaskActionListeners();
  }

  function generateTaskHTML(todo, today) {
    const overdueClass = todo.due_date && todo.due_date < today && !todo.done ? 'overdue' : '';
    const doneClass = todo.done ? 'done' : '';
    
    let dueDateDisplay = '';
    if (todo.due_date) {
      if (todo.due_date.length > 10) {
        dueDateDisplay = `ã€†${todo.due_date.slice(5, 16).replace(' ', '/')}`;
      } else {
        dueDateDisplay = `ã€†${todo.due_date.slice(5)}`;
      }
    }

    const completeAction = todo.done ? 
      `<form action="/undone/${todo.id}" method="post" style="display:inline;">
        <button type="submit" title="æœªå®Œäº†ã«æˆ»ã™">â†©ï¸</button>
      </form>` : 
      `<form action="/done/${todo.id}" method="post" style="display:inline;">
        <button type="submit" title="å®Œäº†">âœ…</button>
      </form>`;

    return `
      <li class="${overdueClass}">
        <span class="${doneClass}">${todo.task}</span>
        <span class="task-meta">${dueDateDisplay}</span>
        <span class="task-actions">
          ${completeAction}
          <form action="/edit/${todo.id}" method="get" style="display:inline;">
            <button type="submit" title="ç·¨é›†">âœï¸</button>
          </form>
          <form action="/delete/${todo.id}" method="post" style="display:inline;">
            <button type="submit" title="å‰Šé™¤">ğŸ—‘ï¸</button>
          </form>
        </span>
      </li>
    `;
  }
</script>
</body>
</html>
