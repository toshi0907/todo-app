# TODO管理アプリ

**バージョン: ver.00.000.001**

Node.js（Express）＋ SQLite3 による高機能なTODO管理アプリです。Ajax対応によりページ再読み込みなしでの快適な操作が可能で、包括的なテストとモバイル最適化を実装済みです。

## 🎯 主な特徴・新機能

### ✨ Ajax化によるモダンなUX
- **ページ再読み込みなし**: タスクの追加・削除・完了操作がスムーズ
- **リアルタイム更新**: 操作後に即座にタスクリストが更新
- **読み込み中フィードバック**: 処理中は⏳エモジで視覚的にお知らせ
- **エラー時自動フォールバック**: 通信エラー時は従来のフォーム送信に自動切替

### 📱 モバイル最適化
- **Pixel 7等対応**: 428px以下の画面で詳細最適化
- **タッチフレンドリー**: 大きなボタン・適切なタップ領域
- **レスポンシブデザイン**: 縦向き・横向き両対応
- **PWAライク**: テーマカラー設定・ビューポート最適化

### 🗂️ カテゴリ管理
- **安全な削除処理**: カテゴリ削除時、該当タスクが未設定カテゴリに自動移動（修正中）
- **データ整合性保証**: 孤立したタスクデータの発生を防止
- **重複制御**: 同名カテゴリの重複登録を防止

### 🎨 洗練されたUI/UX
- **モダンデザイン**: 美しいシャドウ・ボーダーラディウス
- **期限管理**: 日付のみ・日付＋時間の両対応、期限切れタスクの視覚的強調
- **確認ダイアログ**: 削除操作時の誤操作防止
- **現在時刻表示**: 各ページ上部にシステム時刻表示

### 🧪 包括的テスト
- **29テストケース**: 正常系・異常系・API・バグ検証まで網羅
- **Jest + Supertest**: 信頼性の高い自動テスト環境
- **継続的品質管理**: バグ検証テスト含む包括的テストスイート
- **CI/CD Ready**: GitHub Actions対応（設定済み）

## 💾 データベース

- **SQLite3使用**: ファイルベースDB（`todo.db`、テスト時は`test.db`）
- **テーブル構成**:
  - `todos`: id, task, due_date, category_id, done, created_at
  - `categories`: id, name
- **データ整合性**: 外部キー制約・重複制御・カスケード更新対応

## 🛠️ 技術スタック

### バックエンド
- **Node.js** (v18以上推奨)
- **Express.js** - Webフレームワーク
- **SQLite3** - データベース
- **EJS** - テンプレートエンジン

### フロントエンド
- **Bootstrap 5.3** - UIフレームワーク
- **Vanilla JavaScript** - Ajax機能
- **CSS3** - レスポンシブデザイン・アニメーション

### 開発・テスト
- **Jest** - テストフレームワーク
- **Supertest** - HTTP APIテスト
- **GitHub Actions** - CI/CDパイプライン

### Node.js依存パッケージ

```json
{
  "express": "^4.x",
  "sqlite3": "^5.x",
  "ejs": "^3.x",
  "body-parser": "^1.x",
  "dotenv": "^16.x"
}
```

`npm install` で自動インストールされます。

## 📋 主な機能

### タスク管理
- **タスク操作**: 登録・編集・完了・削除・未完了復帰
- **期限設定**: 日付のみ・日付＋時間の両方に対応
- **カテゴリ分類**: 任意でカテゴリを設定・管理
- **期限切れ通知**: 期日を過ぎた未完了タスクは赤色背景で強調表示
- **自動ソート**: カテゴリ未設定→カテゴリ順→期限日→登録日順で整理

### API エンドポイント
- `GET /api/todos` - タスク一覧取得（JSON）
- `POST /api/add` - タスク追加（JSON）
- `POST /api/done/:id` - タスク完了
- `POST /api/undone/:id` - タスク未完了に戻す
- `POST /api/delete/:id` - タスク削除

### カテゴリ管理
- **CRUD操作**: カテゴリの作成・編集・削除
- **データ整合性**: カテゴリ削除時の安全な処理（修正中）
- **重複制御**: 同名カテゴリの重複登録を防止
- **タスクとの連携**: カテゴリとタスクの関連付け管理

## データベース

- SQLite3を使用（ファイル: `todo.db`、テスト時は`test.db`）
- テーブル: `todos`, `categories`
  - `todos`: id, task, due_date, category_id, done, created_at
  - `categories`: id, name

## 📁 ディレクトリ構成

```
todo-app/
├── index.js                 # サーバー本体・メインエントリーポイント
├── package.json             # 依存関係・スクリプト定義
├── .env.sample              # 環境変数サンプル
├── todo.db                  # SQLite DB（自動生成）
├── models/
│   └── db.js               # データベース初期化・接続
├── routes/
│   ├── todos.js            # タスク関連ルーティング・API
│   └── categories.js       # カテゴリ管理ルーティング
├── views/
│   ├── index.ejs           # メイン画面
│   ├── edit.ejs            # タスク編集画面
│   ├── categories.ejs      # カテゴリ管理画面
│   ├── footer.ejs          # 共通フッター
│   └── partials/
│       └── task.ejs        # タスク表示部品
├── public/
│   └── main.css            # 共通CSS・レスポンシブスタイル
├── test/
│   └── todo.test.js        # 自動テスト（29テストケース）
├── .github/workflows/
│   └── deploy.yml          # GitHub Actions CI/CDパイプライン
├── ssl_publish.sh          # SSL対応・公開用スクリプト
├── pm2_setup.sh            # PM2セットアップスクリプト
└── README.md               # このファイル
```

## 🚀 クイックスタート

### 1. 環境準備
```bash
# リポジトリをクローン
git clone <repository-url>
cd todo-app

# 依存関係のインストール
npm install
```

### 2. 環境設定（オプション）
```bash
# 環境変数ファイルをコピー・編集
cp .env.sample .env
# 必要に応じて PORT, DB_FILE, DOMAIN などを設定
```

### 3. サーバー起動
```bash
npm start
```

### 4. ブラウザでアクセス
[http://localhost:3000](http://localhost:3000) にアクセス

### 5. テスト実行（推奨）
```bash
npm test
```
29のテストケースが実行され、現在のアプリケーションの動作確認ができます。

## 📊 現在の開発状況

### ✅ 完了済み機能
- Ajax化による快適なUX
- モバイル最適化（Pixel 7等対応）
- 包括的テストスイート（29テストケース）
- API エンドポイント実装
- レスポンシブデザイン

### 🔧 修正中の課題
- **カテゴリ削除時のデータ整合性**: カテゴリ削除後、該当タスクが表示されなくなる問題
  - 現状: バグ検証テストが追加済み（意図的に失敗状態）
  - 修正予定: 削除時に該当タスクのcategory_idをNULLに更新する処理を実装

### 📋 今後の拡張予定
- プッシュ通知機能
- タスクの優先度設定
- 複数ユーザー対応
- データエクスポート機能

## 📱 モバイル対応

### 対象デバイス
- **Pixel 7** - 詳細最適化済み
- **iPhone** - 各サイズ対応
- **その他Android** - レスポンシブデザイン

### モバイル専用機能
- **タッチ最適化**: 44px以上のタップ領域
- **ズーム防止**: フォーム入力時の画面拡大防止
- **方向対応**: 縦向き・横向き両対応
- **読み込み状態**: Ajax処理中の視覚的フィードバック

## 🧪 テスト

### テストカバレッジ
- **基本機能**: タスク追加・削除・完了・編集（✅）
- **カテゴリ管理**: 作成・編集・削除・データ整合性（🔧修正中）
- **API エンドポイント**: Ajax通信・エラーハンドリング（✅）
- **バリデーション**: 不正データ・エッジケース（✅）
- **バグ検証**: カテゴリ削除時のデータ整合性（🔧検証テスト追加済み）
- **モバイル対応**: レスポンシブデザイン・タッチ操作（✅）

### テスト実行
```bash
# 全テスト実行
npm test

# テスト結果例（修正中につき一部テストが失敗状態）
Test Suites: 1 total
Tests:       29 total (一部バグ検証テストが意図的に失敗)
Time:        ~0.8s

# バグ修正完了後は全テストがパスする予定
```

## 🛠️ 開発・コントリビューション

### 開発環境セットアップ
```bash
# プロジェクトクローン
git clone <repository-url>
cd todo-app

# 依存関係インストール
npm install

# 開発サーバー起動
npm start

# 別ターミナルでテスト実行
npm test
```

### コードベース構成
- **models/**: データベース関連処理
- **routes/**: APIエンドポイント・ルーティング
- **views/**: EJSテンプレート
- **public/**: 静的ファイル（CSS・JS）
- **test/**: 自動テストファイル

### 品質管理
- **ESLint**: コード品質チェック（設定予定）
- **Jest**: 単体テスト・統合テスト
- **手動テスト**: ブラウザでの動作確認
- **Git管理**: コミット単位での機能管理

## 🚀 デプロイ・運用

### 本番環境デプロイ
```bash
# PM2での本番運用
pm2 start index.js --name todo-app
pm2 save
pm2 startup

# SSL対応（Nginx + Let's Encrypt）
bash ssl_publish.sh

# PM2セットアップ
bash pm2_setup.sh
```

### CI/CD パイプライン
- **GitHub Actions**: `.github/workflows/deploy.yml`
- **自動テスト**: プルリクエスト時
- **自動デプロイ**: mainブランチマージ時
- **環境変数**: GitHub Secrets で管理

## 環境変数設定

- `.env.sample` をコピーして `.env` を作成し、必要に応じて編集してください。
  ```bash
  cp .env.sample .env
  ```
- **設定項目**:
  - `PORT`: サーバーポート（デフォルト: 3000）
  - `DB_FILE`: SQLiteデータベースファイルパス
  - `DOMAIN`: 公開用ドメイン名
  - `NODE_ENV`: 実行環境（development/production）

## 📝 更新履歴

### ver.001.000.000 (現在開発中)
- ✅ Ajax化による快適なUX実装
- ✅ モバイル最適化（Pixel 7対応）
- ✅ 包括的テストスイート（29ケース）追加
- ✅ API エンドポイント実装
- ✅ レスポンシブデザイン強化
- 🔧 カテゴリ削除時のデータ整合性バグ修正中

### ver.000.000.001 (初期版)
- 基本的なTODO管理機能
- SQLite3データベース実装
- EJSテンプレート使用
- 基本的なCRUD操作

## 🤝 サポート・コントリビューション

### バグレポート
- GitHub Issues でバグ報告・機能要望を受付
- テスト失敗時のログ・環境情報を添付

### 開発参加
- Fork & Pull Request歓迎
- テスト追加・ドキュメント改善も大歓迎
- コードレビュー・品質向上への協力

### 連絡先
- GitHub: [リポジトリURL]
- Issues: バグ報告・機能要望
- Discussions: 質問・議論

## デプロイ・CI/CD

- `.github/workflows/deploy.yml` でmainブランチpush時に本番サーバーへ自動デプロイ可能
- SSH秘密鍵・ユーザー・ホストはGitHubリポジトリのSecretsに登録してください
- サーバー側はpm2でNode.jsアプリを管理する想定

## SSL対応・公開（Nginx + Let's Encrypt + Basic認証）

- 公開用ドメインを `.env` の `DOMAIN` に設定してください。
- `ssl_publish.sh` を実行すると、Nginxのリバースプロキシ＋SSL証明書自動取得・設定＋Basic認証が行われます。
  - 例: `sudo ./ssl_publish.sh`
  - 初回実行時にBasic認証用のユーザー名・パスワードを対話的に設定できます。
- 事前に80/443番ポートが開放されていること、ドメインのDNSがサーバーIPを向いていることを確認してください。

## 🔧 トラブルシューティング

### 一般的な問題

#### タスクが表示されない
- ブラウザのハードリフレッシュ（Ctrl+F5）を試してください
- Ajax通信エラーの場合、ページを再読み込みしてください
- ネットワーク接続を確認してください

#### モバイルでの表示問題
- ブラウザのズーム設定を100%にリセットしてください
- 対応解像度: 320px〜428px（Pixel 7最適化済み）

### サーバー関連

#### ポート3000が使用中
```bash
# 既存プロセスを確認
lsof -i :3000

# プロセス終了
pkill -f "node index.js"

# 再起動
npm start
```

#### データベースエラー
```bash
# テスト用DBを削除（本番DBは残る）
rm -f test.db

# テスト実行でDB再作成
npm test
```

### 開発者向け

#### Ajax機能のデバッグ
1. ブラウザのDevToolsを開く
2. Networkタブで通信状況を確認
3. Consoleタブでエラーログを確認
4. エラー時は自動的に従来のフォーム送信にフォールバック

#### テスト失敗時
```bash
# 詳細出力でテスト実行
npm test -- --verbose

# 特定テストのみ実行
npm test -- --testNamePattern="API"
```

### デプロイ関連

#### 502 Bad Gateway
- Node.jsアプリが起動していない、またはNginxのproxy_pass先が間違っている可能性があります。
  - `npm start` でアプリが動作しているか確認
  - `curl http://localhost:3000` で応答があるか確認
  - Nginx設定ファイルの `proxy_pass` 行を再確認

#### SSL証明書取得エラー
- Nginx設定の構文エラーや、ドメインのDNS未設定が原因の場合があります。
  - `/etc/nginx/sites-enabled/ドメイン名` の `proxy_set_header` 記述を確認
  - `sudo nginx -t` で構文チェック

#### Basic認証が効かない
- ブラウザのキャッシュやNginx設定ミスの可能性があります。
  - `/etc/nginx/.htpasswd` の存在と内容を確認
  - Nginx設定ファイルの `auth_basic` 記述を確認

---

**最終更新**: 2025年6月 | **ライセンス**: MIT | **Node.js**: v18+ 推奨
